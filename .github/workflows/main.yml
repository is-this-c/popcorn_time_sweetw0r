name: CI

on: [push]

jobs:
  build:
    name: Build

    runs-on: macOS-latest

    steps:
    - uses: actions/checkout@v3.0.0
        
    - name: Get cache
      uses: actions/cache@v3.0.0
      id: cache
      with:
        path: |
          Pods
          PopcornTime.xcworkspace
          Podfile.lock
        key: ${{ runner.os }}_${{ hashFiles('Podfile.lock') }}_v3

    - name: Get dependencies       
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        gem install bundler
        bundle install
        bundle exec pod repo update
        bundle exec pod install
        
    - name: Compile
      run: |
        openssl req -x509 -newkey rsa:4096 -nodes -keyout key.pem -sha256 -out certificate.pem -subj "/CN=iPhone Developer"
        sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain certificate.pem
        sudo xcode-select -s /Applications/Xcode_13.2.1.app
        xcodebuild clean archive \
          -workspace PopcornTime.xcworkspace \
          -scheme PopcornTimeiOS \
          -configuration Debug \
          CODE_SIGN_STYLE="MANUAL" \
          | xcpretty
        
    - name: Package
      run: |
        cd ~
        mkdir Payload
        cp -r Library/Developer/Xcode/Archives/*/*/Products/Applications/PopcornTime.app Payload
        wget https://github.com/sbingner/ldid/releases/download/v2.1.4/osx-ldid.tgz
        tar -xvf osx-ldid.tgz
        #./ldid -S Payload/PopcornTime.app/PopcornTime
        zip -r popcorn_time_tvos.ipa Payload
        rm -r Payload
        
    - name: Upload
      uses: actions/upload-artifact@v3.0.0
      with:
        name: 'popcorn_time_tvos'
        path: |
          ~/popcorn_time_tvos.ipa
